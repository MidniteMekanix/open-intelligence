<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Intelligence platform simple web page for basic intelligence">
  <meta name="author" content="">
  <link rel="icon"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAADhAJiYAAACA0lEQVR4Ae3VAYQiURjA8cNgEMIiDMJicQiLMDgWh0UIixAOh8VgsTgMQoBwCLAIIYTFASCEMDiEEMIghMUifPfHw+fx6s2YHHf75wcY9Z733vfpf+mjFgaYY4WtscAMz7jGRQuRYAfxtEYfldfBBlJShhiVNIBY9nhBF200jRg9TPEGUY74htIFmEGUHI8IcK4QKQ4QZYhSDSHKK+ooWoQlRCm8Uw8QZYQAZQut3T4iLvJxDjHmqKLQ2qkMXqUQY4saqiqyzlQfJwvPfPCEDGM04eozpliif2LBa5zsDmJsoGtDlDFc/bLOS2QtWj8J13A2PnE9E4jyG64OEKUL3RRiPMPZCmLE0DVwhBhPcPXTekRD6HoQYwZnO4gRwa6BBG2c6yu+ow67GGIs4EyUS9a0bvJf/0MRxNjBWQ4xGrhU+sYu4SyDGLe4VF3fSfACMVLng1Zcz/d37DonZk0dO0hBS+gC7CFGC85qeIcY99DFeIN4ynED3aPXgVaNrNc4gK7luVNrNKGrWxcnwdnqOJyZWSES5BDLDj8QQhfg1ZqVAbxKIJ4ruUKML7jx2nmgg0JNIMoYAYpWwxyipChciAXsCX8P3/rYQpQpShdiArFkSHFrvegRYgyxgVgGqKQEB0hJOR5QaVcY4R3i6YAUIS5WDR1MkGFvXfkVxrhDiI/+7f4AfdpSa7k2LiwAAAAASUVORK5CYII=">

  <title>Intelligence - Plates</title>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

  <!-- Custom styles for this template -->
  <link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">

  <!-- Morris css -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css">

  <!-- Magic -->
  <link rel="stylesheet" href="./packages/magic/magic.min.css">

  <!-- App own theme -->
  <!--suppress HtmlUnknownTarget -->
  <link rel="stylesheet" href="style.css">

  <!-- FullCalendar -->
  <link href='packages/full-calendar/core/main.css' rel='stylesheet'/>
  <link href='packages/full-calendar/timegrid/main.css' rel='stylesheet'/>
  <link href='packages/full-calendar/daygrid/main.css' rel='stylesheet'/>

  <!-- Toastr -->
  <link href='packages/toastr/toastr.min.css' rel='stylesheet'/>

</head>

<body>


<!-- Generic image view modal -->
<div class="modal fade bd-example-modal-lg" id="generic_image_modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="generic_modal_title">...</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="generic_modal_description" class="text-muted">
        </p>
        <img id="generic_modal_image" class="card-img-right"
             style="width: 100%; height: 100%;"
             alt="Generic modal image">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- Licence plate add new modal -->
<div class="modal fade bd-example-modal-lg" id="licence_plate_add_modal" tabindex="-1" role="dialog"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add plate</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form class="mt-2">
          <div class="form-group">
            <label for="new_plate_licence_plate">Licence plate</label>
            <input type="text" class="form-control" id="new_plate_licence_plate" aria-describedby="emailHelp">
            <small class="form-text text-muted">Input without lines, example ABC123
            </small>
          </div>
          <div class="form-group">
            <label for="new_plate_owner_name">Owner name</label>
            <input type="text" class="form-control" id="new_plate_owner_name" aria-describedby="emailHelp">
            <small class="form-text text-muted">Give full owner name
            </small>
          </div>
          <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="new_plate_enabled">
            <label class="form-check-label" for="new_plate_enabled">Enabled</label>
          </div>
        </form>
        <button id="new_plate_add_btn" class="btn btn-primary">Add plate</button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- sticky-top -->
<nav class="navbar navbar-dark sticky-top navbar-expand-lg bg-dark">
  <a class="navbar-brand col-sm-3 col-md-2 mr-0"
     style="font-family: 'Playfair Display', Georgia, 'Times New Roman', serif; font-size: 1.5rem;">
    <img
      src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAADhAJiYAAACHklEQVR4Ae3WAWTjUBjA8UNRFMVQFMUwHIahCI7hMBTFUBTDYQiG4RAUBRSHAIaiKIrhAFAURVAURREERVAMRe+PfTzP+faSJsy2Pz9M0rcvSdPk26foq+PxeIkBZlhi+2qOKR5xXvYQVfiI4doa/TKG6WCDvEXwihpmALsdntBFG61XHnqYYA+zA+5OGaSCKcwS3KPieIkDpDAb5h1oCLNn1HOs08QCZndZF7mF2QiVE2+IqXX5vCwfTiDNCrxLF5Ai1w8GkLaoFXi3NpFC6r99FMoH+PsBEUK0lHW+Y4IF+soBr98a6BrSxtrWhlmorPMX0gFN66D3kM61gUJIQ2ubD7OVsk4Ks661fQLpURtoCcmztjVwgPSgrPMH0g5Va3sP0lQbKIYkp9keykfb4Qv8E79Q/882D9JcW4SISn5QtyBt38NATUixtmMCqVHiQG1IC23HCNJViQN1Ic20HZ8gBcoPWtZ6+v/RX8SkyNpWR4ysLezXGuwgXWoD1fAC6ca+XbGHawkurDXuIcUu13cEaYWK/YLveKbWaNlnGQkk32WgOlJIofLCn8Auxm9U7UuFZ0gb/R1Lf275yr5n8PADFw5nXupkvTXHMAv1I1K/lzOYBXnf8OYwW+Emwxp9bGE2OfW1cwy7CAGu0LAeCR6G2MBuUNQvq48UeUtwW/TP/RlGeIFrKQJUy3xS19DBGBF2kGIsEeJaBvnqQ/cPDxGlXpRi3oIAAAAASUVORK5CYII="
      width="36" height="36" class="d-inline-block align-top" alt="">
    Intelligence</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <div class="navbar-nav">
      <a class="nav-item nav-link" id="homeBtn" style="cursor: pointer;">Home</a>
      <a class="nav-item nav-link" id="camerasBtn" style="cursor: pointer;">Cameras</a>
      <a class="nav-item nav-link active" style="cursor: pointer;">Plates <span class="sr-only">(current)</span></a>
      <a class="nav-item nav-link" id="facesBtn" style="cursor: pointer;">Faces</a>
      <a class="nav-item nav-link" id="trainingBtn" style="cursor: pointer;">Training</a>
    </div>
  </div>
</nav>

<main role="main" class="container">

  <div class="col-md-12 mt-2 magictime puffIn">

    <div class="input-group mb-2">
      <div class="input-group-prepend">
        <span class="input-group-text" id="basic-addon1">Day's between</span>
      </div>
      <input id="selected_day_field_start" type="date" class="form-control" placeholder="Change day"
             aria-label="Day change">
      <input id="selected_day_field_end" type="date" class="form-control" placeholder="Change day"
             aria-label="Day change">
      <div class="input-group-append">
        <button class="btn btn-outline-secondary" type="button" id="load_day_btn">Load</button>
      </div>
    </div>

    <div class="d-flex justify-content-center magictime puffIn">
      <div class="custom-control custom-radio custom-control-inline">
        <input checked type="radio" id="optionLoadAll" name="optionInlineRadio1" class="custom-control-input">
        <label class="custom-control-label" for="optionLoadAll">Load all</label>
      </div>
      <div class="custom-control custom-radio custom-control-inline">
        <input type="radio" id="optionDistinctDetection" name="optionInlineRadio1" class="custom-control-input">
        <label class="custom-control-label" for="optionDistinctDetection">Distinct detection</label>
      </div>
      <div class="custom-control custom-radio custom-control-inline">
        <input type="radio" id="optionOwnerDetailNeeded" name="optionInlineRadio1" class="custom-control-input">
        <label class="custom-control-label" for="optionOwnerDetailNeeded">Owner detail needed</label>
      </div>
    </div>

    <div class="card flex-md-row mb-4 box-shadow h-md-250 mt-2"
         style="height: 100%;">
      <div class="card-body d-flex flex-column align-items-center">
        <strong class="d-inline-block mb-2 text-primary">Vehicles | License plates</strong>
        <div id="licence_plate_flex_viewer" class="d-flex flex-wrap mt-2 mb-2">
        </div>
      </div>
    </div>


    <div class="card flex-md-row mb-4 box-shadow h-md-250 mt-2"
         style="height: 100%;">
      <div class="card-body d-flex flex-column align-items-center">
        <table class="table table-striped">
          <thead>
          <tr>
            <th>ID</th>
            <th>Licence plate</th>
            <th>Owner name</th>
            <th>Enabled</th>
            <th>Delete</th>
          </tr>
          </thead>
          <tbody id="licence_plate_manager_table">
          <!-- Content is appended here dynamically -->
          </tbody>
        </table>
        <div class="mb-2">
          <button id="load_license_plates_btn" type="button" class="btn btn-outline-primary btn-sm mt-2 mb-2"
                  style="font-size: 10px;">Load license plates
          </button>
          <button id="add_licence_plate_btn" type="button" class="btn btn-outline-secondary btn-sm mt-2 mb-2"
                  style="font-size: 10px;">Add new license plate
          </button>
        </div>
      </div>
    </div>


    <div class="card flex-md-row mb-4 box-shadow h-md-250 mt-2" style="height: 100%;">
      <div class="card-body d-flex flex-column align-items-center">
        <button id="load_calendar_btn" type="button" class="btn btn-outline-primary btn-sm mt-2 mb-2"
                style="font-size: 10px;">Load calendar
        </button>
        <div id='calendar_loading_indicator'></div>
        <div id='calendar'></div>
      </div>
    </div>


  </div>

</main>

<footer class="intelligence-footer">
  <p>Intelligence <a href="https://github.com/norkator/Open-Intelligence">Github</a>.</p>
  <p>
    <a href="#">Back to top</a>
  </p>
</footer>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->

<script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

<!-- Morris chart -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"
        integrity="sha256-0rg2VtfJo3VUij/UY9X0HJP7NET6tgAY98aMOfwP0P8=" crossorigin="anonymous"></script>

<!-- Adds zooming effect -->
<script src="https://cdn.jsdelivr.net/npm/wheelzoom@4.0.1/wheelzoom.js"
        integrity="sha256-fhru0y6L8Knyrjj57vB7/npV5IUyq6Tvo8g0qoceVwQ=" crossorigin="anonymous"></script>

<!-- FullCalendar -->
<script src='./packages/full-calendar/core/main.js'></script>
<script src='./packages/full-calendar/interaction/main.js'></script>
<script src='./packages/full-calendar/daygrid/main.js'></script>
<script src='./packages/full-calendar/timegrid/main.js'></script>

<!-- Toastr -->
<script src='packages/toastr/toastr.min.js'></script>

<script src="./common.js"></script>

<script>
  $(document).ready(function () {

    // Api url
    const apiUrl = String(window.location.href).replace('plates.html', '');
    SetCommonApiUrl(apiUrl);

    const calendar = $('#calendar');
    const calendar_loading_indicator = $('#calendar_loading_indicator');
    const load_calendar_btn = $('#load_calendar_btn');
    load_calendar_btn.on('click', function () {
      calendar.empty();
      getCalendarEvents();
    });

    const generic_image_modal = $('#generic_image_modal');
    const generic_modal_title = $('#generic_modal_title');
    const generic_modal_description = $('#generic_modal_description');
    const generic_modal_image = $('#generic_modal_image');

    const selected_day_field_start = $('#selected_day_field_start');
    selected_day_field_start.val(new Date(new Date().setDate(new Date().getDate()/* - 7*/)).toISOString().substr(0, 10));
    const selected_day_field_end = $('#selected_day_field_end');
    selected_day_field_end.val(new Date().toISOString().substr(0, 10));

    const load_day_btn = $('#load_day_btn');
    load_day_btn.on('click', function () {
      getPlateDetectionData();
    });

    const licence_plate_add_modal = $('#licence_plate_add_modal');
    const new_plate_licence_plate = $('#new_plate_licence_plate');
    const new_plate_owner_name = $('#new_plate_owner_name');
    const new_plate_enabled = $('#new_plate_enabled');
    const new_plate_add_btn = $('#new_plate_add_btn');
    const add_licence_plate_btn = $('#add_licence_plate_btn');
    add_licence_plate_btn.on('click', function () {
      licence_plate_add_modal.modal('show');
    });
    const load_license_plates_btn = $('#load_license_plates_btn');
    const licence_plate_manager_table = $('#licence_plate_manager_table');
    licence_plate_manager_table.on('click', '.btn', function () {
      if (confirm("Sure to delete this licence plate record?")) {
        manageLicencePlates('remove', this.value, null, null, null, null);
      }
    });
    new_plate_add_btn.on('click', function () {
      manageLicencePlates(
        'add', null,
        String(new_plate_licence_plate.val()).replace('-', ''),
        new_plate_owner_name.val(),
        new_plate_enabled.is(':checked') === true ? 1 : 0,
        null
      );
    });
    load_license_plates_btn.on('click', function () {
      getLicencePlates();
    });

    const licence_plate_flex_viewer = $('#licence_plate_flex_viewer');
    licence_plate_flex_viewer.on('click', 'img', function () {
      const id = $(this).attr('id');
      console.log(id);
      getObjectDetectionImage(id);
    });
    licence_plate_flex_viewer.on('click', 'p', function () {
      licence_plate_add_modal.modal('show');
      new_plate_licence_plate.val($(this).text());
    });

    const optionLoadAll = $('#optionLoadAll');
    const optionDistinctDetection = $('#optionDistinctDetection');
    const optionOwnerDetailNeeded = $('#optionOwnerDetailNeeded');

    function getResultOption() {
      if (optionDistinctDetection.is(":checked")) {
        return 'distinct_detection';
      } else if (optionOwnerDetailNeeded.is(":checked")) {
        return 'owner_detail_needed';
      }
      return 'load_all';
    }

    // getPlateDetectionData();

    // License plate detection data, images and plate strings
    function getPlateDetectionData() {
      appendLoadingIndicator(licence_plate_flex_viewer);
      $.ajax({
        url: apiUrl + 'get/license/plate/detections',
        type: 'POST',
        data: {
          resultOption: getResultOption(),
          selectedDate: null,
          selectedDateStart: selected_day_field_start.val(),
          selectedDateEnd: selected_day_field_end.val(),
        }
      }).done(function (data) {
        licence_plate_flex_viewer.empty();
        if (data.licensePlates.length > 0) {
          data.licensePlates.forEach(licensePlate => {
            licence_plate_flex_viewer.append(
              '<div class="container mb-2">' +
              '  <div class="row">' +
              '    <div class="col mr-0 ml-0 pr-0 pl-0">' +
              '     <p class="lead text-center" style="font-weight: bold; background-color: #f4f4f4; width: 100%; height: 100%">'
              + licensePlate.detectionResult +
              '<br><a style="color: darkgreen; font-size: 12px;">' + licensePlate.detectionCorrected + '</a></p>' +
              '    </div>' +
              '    <div class="col mr-0 ml-0 pr-0 pl-0">' +
              '     <p class="lead text-center" style="font-weight: bold; background-color: #f4f4f4; width: 100%; height: 100%">'
              + licensePlate.ownerName + '</p>' +
              '    </div>\n' +
              '    <div class="col mr-0 ml-0 pr-0 pl-0">' +
              '     <img id="' + licensePlate.objectDetectionFileName + '" title="' + licensePlate.title + '" style="cursor: zoom-in; width: 120px; height: 80px; max-width: 120px; max-height: 120px;" src="' + licensePlate.image + '">' +
              '    </div>' +
              '  </div>' +
              '</div>' +
              '<hr>'
            );
            wheelzoom(document.getElementById(licensePlate.objectDetectionFileName));
          });
        }
      }).fail(function (error) {
        licence_plate_flex_viewer.empty();
      });
    }


    function appendLoadingIndicator(jqueryElement) {
      jqueryElement.append('<div id="loading_indicator_place_holder" style="width: 100%"></div>');
      const loading_indicator_place_holder = $('#loading_indicator_place_holder');
      loading_indicator_place_holder.append('<div id="label_image_loading_indicator" ' +
        'style="width: 100%" class="text-center">' +
        '<div class="spinner-border" role="status">' +
        '<span class="sr-only">Loading...</span>' +
        '</div>' +
        '</div>');
    }


    /**
     * Get object detection image name
     * @param cropped_image_name
     */
    function getObjectDetectionImageFileNameForCroppedImageName(cropped_image_name) {
      $.ajax({
        url: apiUrl + 'get/object/detection/image/for/cropped/image',
        type: 'POST',
        data: {
          croppedImageName: cropped_image_name
        },
      }).done(function (data) {
        getObjectDetectionImage(data.file_name);
      }).fail(function (error) {
        alert(error);
      });
    }


    /**
     * Load object_detection image for given file name
     * @param object_detection_image_file_name
     */
    function getObjectDetectionImage(object_detection_image_file_name) {
      $.ajax({
        url: apiUrl + 'get/object/detection/image',
        type: 'POST',
        data: {
          objectDetectionImageFileName: object_detection_image_file_name
        },
      }).done(function (data) {
        generic_image_modal.modal('show');
        generic_modal_title.text(object_detection_image_file_name);
        generic_modal_description.text('');
        generic_modal_image.attr("src", data.data);
      }).fail(function (error) {
        alert(error);
      });
    }

    /**
     *
     * @param {String} action_type ['add', 'remove', 'changes']
     * @param {Number} id
     * @param {String} licence_plate
     * @param {String} owner_name
     * @param {Number} enabled
     * @param {Array} saveChangesArray
     */
    function manageLicencePlates(action_type = 'add', id, licence_plate, owner_name, enabled, saveChangesArray) {
      $.ajax({
        url: apiUrl + 'manage/licence/plates',
        type: 'POST',
        data: {
          action_type: action_type,
          id: id,
          licence_plate: licence_plate,
          owner_name: owner_name,
          enabled: enabled,
          save_change_array: JSON.stringify(saveChangesArray),
        },
      }).done(function (data) {
        if (action_type === 'add') {
          alert('New plate ' + licence_plate + ' added.');
        } else if (action_type === 'remove') {
          alert('Plate removed.');
        }
      }).fail(function (error) {
        alert(error);
      });
    }


    function getLicencePlates() {
      licence_plate_manager_table.empty();
      $.ajax({
        url: apiUrl + 'get/licence/plates',
        type: 'GET',
      }).done(function (data) {
        if (data.plates.length > 0) {
          data.plates.forEach(function (plate) {
            licence_plate_manager_table.append(
              '<tr>' +
              '<th scope="row" class="pId">' + plate.id + '</th>' +
              '<td><input class="form-control pLp" type="text" value="' + plate.licence_plate + '"></td>' +
              '<td><input class="form-control pOn" type="text" value="' + plate.owner_name + '"></td>' +
              '<td style="text-align: center"><input class="form-check-input pE" type="checkbox" value="option1" ' + (plate.enabled === 1 ? 'checked' : '') + '></td>' +
              '<td><button type="button" value="' + plate.id + '" class="btn btn-danger" role="button">Delete</button></td>' +
              '</tr>'
            );
          });
        }
      }).fail(function (error) {
        console.log(error);
      });
    }


    function getCalendarEvents() {
      appendLoadingIndicator(calendar_loading_indicator);
      $.ajax({
        url: apiUrl + 'get/calendar/events',
        type: 'POST',
        data: {},
      }).done(function (data) {
        drawCalendar(data.events);
      }).fail(function (error) {
        alert(error);
      });
    }


    function drawCalendar(events = []) {
      console.info(events.length);
      calendar_loading_indicator.empty();
      let calendarEl = document.getElementById('calendar');
      let calendar = new FullCalendar.Calendar(calendarEl, {
        plugins: ['interaction', 'dayGrid', 'timeGrid'],
        header: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        defaultDate: new Date().toISOString(),
        navLinks: true, // can click day/week names to navigate views
        selectable: false,
        selectMirror: true,
        editable: false,
        eventLimit: true, // allow "more" link when too many events
        events: events,
        eventTimeFormat: {
          hour: '2-digit', //2-digit, numeric
          minute: '2-digit', //2-digit, numeric
          meridiem: true, //lowercase, short, narrow, false (display of AM/PM)
          hour12: false //true, false
        },
        timeFormat: 'HH:mm',
        eventClick: function (info) {
          toastr.info(info.event.extendedProps.description, info.event.title, {timeOut: 2500});
          getObjectDetectionImageFileNameForCroppedImageName(info.event.extendedProps.file_name_cropped);
        }
      });
      calendar.render();
    }


  });


</script>

</body>
</html>
